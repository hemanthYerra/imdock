version: '2'

services:

    #--------------------------------------
    # Mail Testing
    #--------------------------------------

    smartdocker-mailhog:
       image: phpdockerio/mailhog:latest
       container_name: smartdocker-mailhog
       ports:
         - "8081:8025"


    #--------------------------------------
    # Cache
    #--------------------------------------

    smartdocker-memcached:
      image: phpdockerio/memcached:latest
      container_name: smartdocker-memcached
      volumes:
          - ../memcached:/var/lib/redis


    smartdocker-redis:
      image: phpdockerio/redis:latest
      container_name: smartdocker-redis
      volumes:
          - ../redis:/var/lib/redis


    #--------------------------------------
    # Database
    #--------------------------------------

    smartdocker-mysql:
       image: mysql:5.7
       container_name: smartdocker-mysql

       ports:
          - "3306:3306"
       environment:
         - MYSQL_ROOT_PASSWORD=P@ssw0rd
         - MYSQL_DATABASE=smart-db
         - MYSQL_USER=adminuser
         - MYSQL_PASSWORD=P@ssw0rd
       command: --character-set-server=utf8
                 --collation-server=utf8_unicode_ci
                 --connect-timeout=10
                 --max-connections=1000
                 --max-allowed-packet=32M
                 --thread-cache-size=300
                 --sort-buffer-size=4M
                 --bulk-insert-buffer-size=16M
                 --tmp-table-size=256M
                 --max-heap-table-size=2048M
                 --query-cache-limit=4M
                 --query-cache-size=64M
                 --query-cache-type=0
                 --long-query-time=10
                 --expire-logs-days=10
                 --max-binlog-size=100M
                 --innodb-buffer-pool-size=256M
                 --innodb-log-buffer-size=32M
                 --innodb-file-per-table=1
                 --innodb-open-files=400
                 --innodb-io-capacity=400
                 --innodb-flush-method=O_DIRECT
                 --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
       volumes:
         - ../mysql:/var/lib/mysql
         - ../tmp:/tmp



    smartdocker-postgres:
        image: postgres:9.6
        container_name: smartdocker-postgres
        environment:
          - POSTGRES_USER=adminuser
          - POSTGRES_PASSWORD=P@ssw0rd
          - POSTGRES_DB=P@ssw0rd

    #--------------------------------------
    # Web Service
    #--------------------------------------

    smartdocker-nginx:
        image: phpdockerio/nginx:latest
        container_name: smartdocker-nginx
        volumes:
            - ../website:/var/www/smartdocker
            - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
            - ./nginx/sites-include:/etc/nginx/conf.d/sites-include/
        ports:
            - "80:80"
        links:
            - smartdocker-php7-fpm
            - smartdocker-php56-fpm

    #--------------------------------------
    # PHP Program
    #--------------------------------------

    smartdocker-php7-fpm:
        build:
          context: ./php-fpm
          dockerfile: Dockerfile7
        container_name: smartdocker-php7-fpm
        volumes:
            - ../website:/var/www/smartdocker
            - ./php-fpm/php-ini-overrides.ini:/etc/php/7.1/fpm/conf.d/99-overrides.ini
        ports:
            - "9001:9000"


    smartdocker-php56-fpm:
        build:
          context: ./php-fpm
          dockerfile: Dockerfile56
        container_name: smartdocker-php56-fpm
        volumes:
            - ../website:/var/www/smartdocker
            - ./php-fpm/php-ini-overrides.ini:/etc/php5/fpm/conf.d/99-overrides.ini
        ports:
            - "9002:9000"